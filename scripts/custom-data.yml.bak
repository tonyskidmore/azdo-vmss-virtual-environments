#cloud-config

# https://github.com/Azure/WALinuxAgent/issues/1938

bootcmd:
  - mkdir -p /etc/systemd/system/walinuxagent.service.d
  - echo "[Unit]\nAfter=cloud-final.service" > /etc/systemd/system/walinuxagent.service.d/override.conf
  - sed "s/After=multi-user.target//g" /lib/systemd/system/cloud-final.service > /etc/systemd/system/cloud-final.service
  - systemctl daemon-reload

runcmd:
  - echo "running as: $(whoami)"
  - find /opt/post-generation -mindepth 1 -maxdepth 1 -type f -name "*.sh" -exec bash {} \;
  - timeout 15m bash -c 'until pidof Agent.Listener; do echo "Waiting for Agent.Listener" && sleep 10; done'
  - sleep 10
  - sed -i.bak "/secure_path/d" /etc/sudoers
  - pathFromEnv=$(cut -d= -f2 /etc/environment | tail -1); echo "Defaults secure_path=\"$pathFromEnv\"" >> /etc/sudoers
  - pathFromEnv=$(cut -d= -f2 /etc/environment | tail -1); echo "$pathFromEnv > /agent.path"; echo "$pathFromEnv" > /agent/.path
  - 
  - echo "running: sudo -E runuser AzDevOps -c '/bin/sh /agent/run.sh"
  - echo "sudo -E runuser AzDevOps -c '/bin/bash /agent/run.sh'" | at now




# get path information from /etc/environment
pathFromEnv=$(cut -d= -f2 /etc/environment | tail -1)
printf "pathFromEnv:\n %s\n" "$pathFromEnv"

# update /etc/sudoers secure_path
sed -i.bak "/secure_path/d" /etc/sudoers
echo "Defaults secure_path=$pathFromEnv" >> /etc/sudoers
# debug
cat /etc/sudoers

# update agent path files
echo "$pathFromEnv > /agent.path"
echo "$pathFromEnv" > /agent/.path

if pidof Agent.Listener > /dev/null
then
  agent_pid=$(pidof Agent.Listener)
  printf "killing Agent.Listener process: %s\n" "$agent_pid"
  kill "$agent_pid"
else
  echo "Agent.Listener process not found"
fi

echo "pgrep run.sh: $(pgrep -f 'run.sh')"
echo "pgrep Agent.Listener: $(pgrep -f 'Agent.Listener')"

# finally restart the Azure DevOps agent after the path updates
echo "running: sudo -E runuser AzDevOps -c '/bin/sh /agent/run.sh"
echo "sudo -E runuser AzDevOps -c '/bin/bash /agent/run.sh'" | at now
